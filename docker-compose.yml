# docker-compose.yml
version: '3.8'

services:
  # ------------------------------------
  # 1. СЕРВИС БАЗЫ ДАННЫХ (PostgreSQL)
  # ------------------------------------
  db:
    image: postgres:16-alpine # Легкий образ PostgreSQL
    container_name: recruitment_db_container
    restart: always
    environment:
      # Используем переменные из .env для настройки БД
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    # Пробрасываем порт на хост, чтобы иметь доступ к БД извне (опционально)
    # ports:
    #   - "5432:5432"
    volumes:
      # Постоянное хранение данных
      - postgres_data:/var/lib/postgresql/data/

  # ------------------------------------
  # 2. СЕРВИС ПРИЛОЖЕНИЯ (Python Bot)
  # ------------------------------------
  app:
    build: . # Использовать локальный Dockerfile
    container_name: welcome_bot_container
    restart: always
    # Указываем зависимость от БД: приложение не запустится, пока БД не будет готова
    depends_on:
      - db
    env_file:
      - .env # Передаем переменные окружения из .env в контейнер
    # Переопределяем команду запуска, используя python -m
    command: python -m bot_welcome.main
    # Ждем, пока Postgres полностью проинициализируется
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data: